{% extends 'main_app/student_base.html' %}

{% load static %}

{% block title %}Enrollment | Hogwarts University{% endblock %}

{% block content %}
<div class="p-8">
    <!-- Conflict Alert Modal -->
    <div class="modal fade fixed top-20 left-200 hidden outline-none overflow-x-hidden overflow-y-auto" id="conflictModal" tabindex="-1" aria-labelledby="conflictModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered relative w-auto pointer-events-none">
            <div class="modal-content border-none shadow-lg relative flex flex-col w-full pointer-events-auto bg-white bg-clip-padding rounded-md outline-none text-current">
                <div class="modal-header bg-red-600 text-white flex flex-shrink-0 items-center justify-between p-4 rounded-t-md">
                    <h5 class="text-xl font-medium leading-normal" id="conflictModalLabel">
                        <i class="fas fa-exclamation-triangle mr-2"></i> Scheduling Conflicts Detected
                    </h5>
                    <button type="button" class="btn-close box-content w-4 h-4 p-1 text-white border-none rounded-none opacity-50 focus:shadow-none focus:outline-none focus:opacity-100 hover:text-white hover:opacity-75 hover:no-underline" data-bs-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body relative p-4">
                    <div id="conflictDetails" class="text-gray-800"></div>
                </div>
                <div class="modal-footer flex flex-shrink-0 flex-wrap items-center justify-end p-4 rounded-b-md bg-gray-50">
                    <button type="button" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors" data-bs-dismiss="modal">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if approved_enrollment %}
        <div class="bg-gray-100 border-l-4 border-gray-500 text-gray-800 p-4 rounded-lg shadow-sm mb-6">
            <div class="flex items-start">
                <i class="fas fa-check-circle text-gray-600 text-2xl mr-3 mt-1"></i>
                <div>
                    <h4 class="text-xl font-bold mb-2">Enrollment Approved!</h4>
                    <p class="mb-2">Your enrollment (ID: <span class="font-semibold">{{ approved_enrollment.enroll_id }}</span>) has been approved.</p>
                    {% if approved_enrollment.stud_is_regular %}
                        <p>You have been assigned to <span class="font-semibold bg-gray-200 px-2 py-1 rounded">{{ approved_enrollment.enrolldetail_set.first.sched.sec.section_name }}</span> section.</p>
                    {% endif %}
                    <div class="mt-3 space-x-2">
                        <a href="{% url 'my_schedule' %}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg inline-flex items-center transition-colors">
                            <i class="fas fa-calendar-alt mr-2"></i> View Your Schedule
                        </a>
                        {% if not pending_enrollment %}
                            <a href="?new_enrollment=true" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg inline-flex items-center transition-colors border border-gray-300">
                                <i class="fas fa-plus-circle mr-2"></i> New Enrollment
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% elif pending_enrollment %}
        <div class="bg-gray-100 border-l-4 border-gray-500 text-gray-800 p-4 rounded-lg shadow-sm mb-6">
            <div class="flex items-start">
                <i class="fas fa-hourglass-half text-gray-600 text-2xl mr-3 mt-1"></i>
                <div>
                    <h4 class="text-xl font-bold mb-2">Enrollment Pending Approval</h4>
                    <p class="mb-2">Your enrollment (ID: <span class="font-semibold">{{ pending_enrollment.enroll_id }}</span>) for 
                       <span class="font-semibold">{{ pending_enrollment.enroll_sem }}</span> is awaiting admin approval.</p>
                    <p class="mb-2">Submitted on: <span class="font-semibold">{{ pending_enrollment.enroll_date|date:"F j, Y H:i" }}</span></p>
                    <p>Please check back later.</p>
                </div>
            </div>
        </div>
    {% else %}

    {% if validation_error %}
        <div class="bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg shadow-sm mb-6">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-3"></i>
                <div>{{ validation_error }}</div>
            </div>
        </div>
    {% endif %}
    
        <form method="post" id="enrollmentForm" action="{% url 'submit_enrollment' %}">
            {% csrf_token %}
            
            <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6 border border-gray-200">
                <div class="bg-gray-800 text-white px-6 py-4">
                    <h5 class="font-bold text-lg flex items-center">
                        <i class="fas fa-file-alt mr-2"></i> Enrollment Details
                    </h5>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Academic Year</label>
                            <input type="text" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 text-gray-800" 
                                   value="{{ current_year.acad_year_date }}" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Student ID</label>
                            <input type="text" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 text-gray-800" 
                                   value="{{ student.stud_id }}" readonly>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Year Level</label>
                            <select class="w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:ring-gray-500 focus:border-gray-500" 
                                    name="year_level" id="yearLevelSelect" required>
                                {% for value, display in year_level_choices %}
                                    <option value="{{ value }}" 
                                        {% if value == default_year_level %}selected{% endif %}
                                        {% if value != default_year_level %}disabled{% endif %}>
                                        {{ display }}
                                    </option>
                                {% endfor %}
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Automatically determined based on your progress</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                            <select class="w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:ring-gray-500 focus:border-gray-500" 
                                    name="semester" id="semesterSelect" required>
                                {% for value, display in semester_choices %}
                                    <option value="{{ value }}" 
                                        {% if value != default_semester %}disabled{% endif %}
                                        {% if value == default_semester %}selected{% endif %}>
                                        {{ display }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Enrollment Type</label>
                            <select class="w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-800 focus:ring-gray-500 focus:border-gray-500" 
                                    name="enrollment_type" id="enrollmentType">
                                <option value="regular" 
                                        {% if student_is_regular %}selected{% endif %}
                                        {% if not student_is_regular %}disabled{% endif %}>
                                    Regular (Block Section)
                                </option>
                                <option value="irregular" {% if not student_is_regular %}selected{% endif %}>
                                    Irregular (Choose Subjects)
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Regular Enrollment Section -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6 border border-gray-200 {% if not student_is_regular %}hidden{% endif %}" id="regularEnrollmentSection">
                <div class="bg-gray-800 text-white px-6 py-4">
                    <h5 class="font-bold text-lg flex items-center">
                        <i class="fas fa-users mr-2"></i> Block Section Enrollment
                    </h5>
                </div>
                <div class="p-6">
                    <div class="bg-gray-50 border-l-4 border-gray-500 text-gray-800 p-4 rounded">
                        <p>As a regular student, you will be automatically assigned to an appropriate section 
                        for <span class="font-semibold" id="displayYearLevel">{{ default_year_level }}</span> 
                        <span class="font-semibold" id="displaySemester">{{ default_semester }}</span>.</p>
                    </div>
                </div>
            </div>
            
            <!-- Irregular Enrollment Section -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6 border border-gray-200 {% if student_is_regular and not is_first_time %}hidden{% endif %}" id="irregularEnrollmentSection">
                <div class="bg-gray-800 text-white px-6 py-4">
                    <h5 class="font-bold text-lg flex items-center">
                        <i class="fas fa-tasks mr-2"></i> Irregular Enrollment - Select Courses
                    </h5>
                </div>
                <div class="p-6">
                    {% if not student_is_regular or is_first_time %}
                        {% if is_first_time %}
                            <div class="bg-gray-50 border-l-4 border-gray-500 text-gray-800 p-4 rounded mb-4">
                                <div class="flex items-start">
                                    <i class="fas fa-info-circle mr-2 mt-1"></i>
                                    <p>As a first-time enrollee, you can select from available first semester courses.</p>
                                </div>
                            </div>
                        {% else %}
                            <div class="bg-amber-50 border-l-4 border-amber-500 text-amber-800 p-4 rounded mb-4">
                                <div class="flex items-start">
                                    <i class="fas fa-exclamation-triangle mr-2 mt-1"></i>
                                    <div>
                                        <p>You have failed courses from previous semesters.</p>
                                        <p class="mt-1">Please select the courses you need to retake along with your current semester courses.</p>
                                    </div>
                                </div>
                            </div>
                            
                            {% if failed_courses %}
                                <div class="mb-4 bg-gray-50 p-4 rounded-lg">
                                    <h6 class="font-semibold text-gray-800 mb-2">Your Failed Courses:</h6>
                                    <ul class="list-disc pl-5 text-gray-700">
                                        {% for course in failed_courses %}
                                            <li>{{ course.crs_code }} - {{ course.crs_name }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        {% endif %}
                        
                        {% if available_courses %}
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Course Code</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Course Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Units</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Schedule Options</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        {% for course in available_courses %}
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ course.crs_code }}</td>
                                            <td class="px-6 py-4 text-sm text-gray-800">{{ course.crs_name }}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ course.crs_unit }}</td>
                                            <td class="px-6 py-4 text-sm text-gray-700">
                                                <select class="w-full border border-gray-300 rounded-lg px-3 py-1 text-gray-800 schedule-select" 
                                                        name="course_schedule" 
                                                        data-course-code="{{ course.crs_code }}">
                                                    <option value="">Select Schedule</option>
                                                </select>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                <button type="submit" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center" id="submitBtn">
                    <i class="fas fa-paper-plane mr-2"></i> Submit Enrollment
                </button>
                
                {% if is_first_time and not pending_enrollment and not approved_enrollment %}
                    <a href="?force_irregular=true" class="bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors border border-gray-300 flex items-center">
                        <i class="fas fa-list-check mr-2"></i> Enroll as Irregular
                    </a>
                {% endif %}
            </div>
        </form>
    {% endif %}
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize enrollment type based on student status
    const isRegular = "{{ student_is_regular|yesno:'true,false' }}" === "true";
    const isFirstTime = "{{ is_first_time|yesno:'true,false' }}" === "true";
    
    // For first-time enrollees, default to irregular if forced
    if (isFirstTime && new URLSearchParams(window.location.search).has('force_irregular')) {
        $('#enrollmentType').val('irregular');
        $('#regularEnrollmentSection').addClass('hidden');
        $('#irregularEnrollmentSection').removeClass('hidden');
    }

    if (!isRegular) {
        $('#enrollmentType').val('irregular');
        $('#regularEnrollmentSection').addClass('hidden');
        $('#irregularEnrollmentSection').removeClass('hidden');
    }

    // Update displayed year level and semester
    function updateDisplay() {
        $('#displayYearLevel').text($('#yearLevelSelect').val());
        $('#displaySemester').text($('#semesterSelect').val());
    }

    // Function to validate the form before submission
    function validateForm() {
        const enrollmentType = $('#enrollmentType').val();
        if (enrollmentType === 'irregular') {
            const selectedSchedules = $('[name="course_schedule"]').filter(function() {
                return $(this).val() !== '';
            }).length;
            
            if (selectedSchedules === 0) {
                alert('Please select at least one course schedule for irregular enrollment');
                return false;
            }
        }
        return true;
    }

    // Initialize Bootstrap modals
    document.addEventListener('DOMContentLoaded', function() {
        var conflictModal = new bootstrap.Modal(document.getElementById('conflictModal'), {
            backdrop: 'static',
            keyboard: false
        });
        
        // Make it available globally if needed
        window.conflictModal = conflictModal;
    });
    
    // Function to check for time conflicts
    function hasTimeConflict(selectedSchedules) {
        const conflicts = [];
        const dayTimeMap = {};
        
        // First build a map of all scheduled times by day
        for (const schedule of selectedSchedules) {
            const days = schedule.raw_days;
            const times = schedule.raw_times;
            
            for (let i = 0; i < days.length; i++) {
                const day = days[i];
                const timeSlot = times[i];
                
                if (!dayTimeMap[day]) {
                    dayTimeMap[day] = [];
                }
                
                // Add course info to the time slot
                const slotWithInfo = {
                    ...timeSlot,
                    course_code: schedule.course_code,
                    course_name: schedule.course_name,
                    display: `${schedule.course_code} (${schedule.course_name}) - ${day} ${timeSlot.start}-${timeSlot.end}`
                };
                
                dayTimeMap[day].push(slotWithInfo);
            }
        }
        
        // Now check for conflicts on each day
        for (const day in dayTimeMap) {
            const slots = dayTimeMap[day];
            
            // Compare each slot with every other slot
            for (let i = 0; i < slots.length; i++) {
                for (let j = i + 1; j < slots.length; j++) {
                    if (timeOverlap(slots[i], slots[j])) {
                        conflicts.push({
                            day: day,
                            slot1: slots[i],
                            slot2: slots[j]
                        });
                    }
                }
            }
        }
        
        return conflicts.length > 0 ? conflicts : false;
    }

    function timeOverlap(slot1, slot2) {
        const start1 = timeToMinutes(slot1.start);
        const end1 = timeToMinutes(slot1.end);
        const start2 = timeToMinutes(slot2.start);
        const end2 = timeToMinutes(slot2.end);
        
        return (start1 < end2) && (end1 > start2);
    }

    function timeToMinutes(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    }

    function showConflictAlert(conflicts) {
        let conflictMessage = "<p class='font-medium mb-3'>You have scheduling conflicts:</p><ul class='space-y-3'>";
        
        conflicts.forEach((conflict, index) => {
            conflictMessage += `
                <li class="bg-red-50 p-3 rounded border-l-4 border-red-500">
                    <strong class="text-red-700">Conflict ${index + 1} on ${conflict.day}:</strong><br>
                    <div class="ml-4 mt-1">
                        <div class="flex items-start">
                            <i class="fas fa-times text-red-500 mr-2 mt-1"></i>
                            <div>${conflict.slot1.display}</div>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-times text-red-500 mr-2 mt-1"></i>
                            <div>${conflict.slot2.display}</div>
                        </div>
                    </div>
                </li>
            `;
        });
        
        conflictMessage += "</ul><p class='mt-4 font-medium'>Please adjust your schedule selections to resolve these conflicts.</p>";
        
        // Display in Bootstrap modal
        $('#conflictDetails').html(conflictMessage);
        $('#conflictModal').modal('show');
    }

    // Function to load schedules for a course
    function loadSchedules(selectElement) {
        const courseCode = selectElement.data('course-code');
        
        if (selectElement.find('option').length <= 1) {
            $.get('/enrollment/get-schedules/', {course_code: courseCode}, function(data) {
                selectElement.empty();
                selectElement.append('<option value="">Select Schedule</option>');
                
                $.each(data, function(index, schedule) {
                    const option = $(
                        `<option value="${schedule.sched_id}" 
                         data-schedule-data='${JSON.stringify(schedule)}'>
                            ${schedule.display}
                        </option>`
                    );
                    selectElement.append(option);
                });
            });
        }
    }
    
    // Initialize schedule selects for available courses
    $('.schedule-select').each(function() {
        loadSchedules($(this));
    });

    // Handle form submission
    $('#enrollmentForm').on('submit', function(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            return false;
        }
        
        // For irregular enrollment, check for schedule conflicts
        if ($('#enrollmentType').val() === 'irregular') {
            const selectedOptions = $('[name="course_schedule"]').filter(function() {
                return $(this).val() !== '';
            });
            
            // Get all selected schedule data
            const selectedSchedules = [];
            selectedOptions.each(function() {
                const selectedOption = $(this).find('option:selected');
                if (selectedOption.length && selectedOption.data('schedule-data')) {
                    selectedSchedules.push(selectedOption.data('schedule-data'));
                }
            });
            
            // Check for time conflicts
            const conflicts = hasTimeConflict(selectedSchedules);
            if (conflicts) {
                showConflictAlert(conflicts);
                return false;
            }
        }
        
        // Disable submit button to prevent double submission
        $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...');
        
        // Submit form via AJAX
        $.ajax({
            type: 'POST',
            url: $(this).attr('action'),
            data: $(this).serialize(),
            success: function(response) {
                if (response.redirect) {
                    window.location.href = response.redirect + '?submitted=true';
                } else if (response.message) {
                    alert(response.message);
                    window.location.reload();
                }
            },
            error: function(xhr, errmsg, err) {
                $('#submitBtn').prop('disabled', false).html('<i class="fas fa-paper-plane mr-2"></i> Submit Enrollment');
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    alert("Error: " + xhr.responseJSON.error);
                } else {
                    alert("Error submitting enrollment. Please try again.");
                }
            }
        });
    });
    
    // Toggle between regular and irregular enrollment
    $('#enrollmentType').change(function() {
        if ($(this).val() === 'regular') {
            $('#regularEnrollmentSection').removeClass('hidden');
            $('#irregularEnrollmentSection').addClass('hidden');
        } else {
            $('#regularEnrollmentSection').addClass('hidden');
            $('#irregularEnrollmentSection').removeClass('hidden');
            
            // Load schedules for available courses
            $('.schedule-select').each(function() {
                loadSchedules($(this));
            });
        }
    });
    
    // Update display when year level or semester changes
    $('#yearLevelSelect, #semesterSelect').change(function() {
        updateDisplay();
    });
    
    // Handle schedule selection changes
    $(document).on('change', '.schedule-select', function() {
        const selectedOption = $(this).find('option:selected');
        if (selectedOption.val()) {
            // Store the display text
            $(this).data('display-text', selectedOption.text());
            // Store the full schedule data if available
            if (selectedOption.data('schedule-data')) {
                $(this).data('schedule-data', selectedOption.data('schedule-data'));
            }
        }
    });
    
    // Initial display update
    updateDisplay();
});
</script>
{% endblock %}